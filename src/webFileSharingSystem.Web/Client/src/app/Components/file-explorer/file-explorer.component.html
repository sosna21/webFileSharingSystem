<div class="d-flex flex-row pt-3 pb-2">
  <div class="align-self-center mr-3">
    <h2>{{title}}</h2>
  </div>
  <div *ngIf="mode === 'GetAll'" class="align-self-center mr-3">
    <fa-icon size="2x" id="faCircle" [icon]="['fas', 'folder-plus']"
             (click)="initDirCreate(form); createDirTextInput.setFocus();"></fa-icon>
  </div>
  <div class="align-self-end pt-3">
    <form hidden #form [formGroup]="fileNameForm" (ngSubmit)="createDirectory(); form.hidden = true">
      <app-text-input #createDirTextInput [formControl]="$any(fileNameForm).controls['dirName']"
                      [label]="'Folder name'" [errors]="false" (focusin)="fileNameForm.markAllAsTouched()"
                      (focusout)="form.hidden = true; gRename = false;"></app-text-input>
    </form>
  </div>
</div>

<div>
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a routerLink="/files" routerLinkActive="active">
        <span><fa-icon [icon]="['fas', 'home']"></fa-icon></span>
        Home
      </a></li>
      <li *ngFor="let item of breadCrumbs" class="breadcrumb-item ">
        <a [routerLink]="['/files', item.id]">{{item.fileName}}</a></li>
    </ol>
  </nav>
</div>

<div id="table" class="row">
  <div class="table-responsive" style="overflow: visible">
    <table class="table table-sm table-hover">
      <thead>
      <tr>
        <th scope="col" style="width: 2%">
          <input type="checkbox" [checked]="isAllCheckBoxChecked()" (change)="checkAllCheckBox($event)">
        </th>
        <th scope="col" style="width: 60%" class="text-left">File Name

          <span *ngIf="isManyCheckboxesChecked()" class="dropdown ml-3" dropdown #dropdown="bs-dropdown"
                (onShown)="hideOnSecondOpen(dropdown)">
            <span id="actionBtn" dropdownToggle>
            <fa-icon [icon]="['fas', 'ellipsis-h']" [styles]="{'color': 'black'}"></fa-icon>
            Actions  </span>
            <span class="dropdown-menu mt-3" *dropdownMenu>
              <a class="dropdown-item">Download</a>
              <a class="dropdown-item" (click)="moveCopyInit()">Move / Copy</a>
              <a class="dropdown-item" (click)="openModal(deleteTemplate) ;markCheckedFiles()">Delete</a>
            </span>
          </span>
          <div *ngIf="fileExplorerService.filesToMoveCopy.length>0" class="custom-control-inline ml-3">
            <button class="btn btn-dark btn-sm mr-1" (click)="moveCopyFiles(false)">Move here</button>
            <button class="btn btn-dark btn-sm mr-1" (click)="moveCopyFiles(true)">Copy here</button>
            <button class="btn btn-secondary btn-sm" (click)="this.fileExplorerService.filesToMoveCopy = []">Cancel
            </button>
          </div>
        </th>
        <th scope="col" style="width: 4%">Favourite</th>
        <th scope="col" style="width: 4%">Share</th>
        <th scope="col" style="width: 4%">Actions</th>
        <th scope="col" style="width: 8%">Size</th>
        <th scope="col" style="width: 16%">Last Modification</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let file of files; let fileIndex=index">
        <td>
          <input type="checkbox" [hidden]="!file.isCompleted" value="{{file.id}}"
                 (change)="file.checked = !file.checked" [checked]="file.checked">
          <fa-icon [hidden]="file.isCompleted" [icon]="['far', 'trash-alt']" (click)="cancelUpload(file)" [styles]="{'color': '#8c2e2e'}"></fa-icon>
        </td>
        <td *ngIf="!file.rename" class="text-left">
          <div [routerLink]="file.isDirectory ? ['/files',file.id] : null" class="row col-12 align-items-center"
               [style]="{'cursor': file.isDirectory ? 'pointer' : 'default'}">
            <div [ngClass]="file.isCompleted ? '' : 'col-lg-6 col-md-8 col-sm-10'" class="pl-0">
              <fa-icon [style]="{'cursor': file.isDirectory ? 'pointer' : 'default'}" class="mr-sm-1" size="2x"
                       [icon]="[file.isDirectory ? 'fas' : 'far', (file | mimeFontawesome)]"></fa-icon>
              {{ file.fileName }} | {{file.id}} | {{file.mimeType}}
            </div>
            <div *ngIf="!file.isCompleted" class="row align-items-center col-lg-6 col-md-4 col-sm-2 ">
              <div class="col p-0 d-none d-lg-block">
                <div class="progress progress-sm bg-dark ">
                  <div [class]="file.stopped ? 'bg-danger' : 'progress-bar-animated'"
                       class="progress-bar progress-bar-striped bg-info" role="progressbar"
                       [ngStyle]="{ 'width': file.uploadProgress + '%'}"></div>
                </div>
              </div>
              <fa-icon size="lg" [class.fa-disabled]="!file.stopped" class="mr-sm-1 ml-sm-1"
                       [icon]="['fas', 'play-circle']" (click)="continueUpload(file)"></fa-icon>
              <fa-icon size="lg" [class.fa-disabled]="file.stopped" [icon]="['fas', 'stop-circle']"
                       (click)="stopUpload(file)"></fa-icon>
            </div>
          </div>

        </td>
        <td #renameInput hidden class="text-left">
          <form [formGroup]="fileNameForm" (ngSubmit)="rename(file); renameInput.hidden = true">
            <app-text-input #renameTextInput (focusin)="fileNameForm.markAllAsTouched()"
                            (focusout)="rename(file); renameInput.hidden = true"
                            (keydown.enter)="rename(file); renameInput.hidden = true"
                            [formControl]="$any(fileNameForm).controls['fileName']"
                            [label]="file.fileName"
                            [value]="file.fileName"></app-text-input>
          </form>
        </td>
        <td>
          <fa-icon [class.fa-disabled]="!file.isCompleted" [icon]="['fas', 'star']" (click)="SetFavourite(file)"
                   [styles]="{'stroke-width': '40','stroke': 'gray', 'color': file.isFavourite ? 'yellow' : 'white'}"></fa-icon>
        </td>
        <td>
          <fa-icon [class.fa-disabled]="!file.isCompleted" [icon]="['fas', 'share-alt']"
                   (click)="openModal(shareTemplate); file.isCompleted ? file.isShared = !file.isShared : null"
                   [styles]=" {'color': file.isShared ? 'black' : '#bfbbbb'}"></fa-icon>
        </td>

        <td>

          <div #dropdown="bs-dropdown" [dropup]="fileIndex >= (itemsPerPage-2)" [isDisabled]="!file.isCompleted"
               class="btn-group" dropdown (onShown)="hideOnSecondOpen(dropdown)">
            <fa-icon dropdownToggle [class.fa-disabled]="!file.isCompleted" [icon]="['fas', 'ellipsis-h']"
                     [styles]="{'color': '#60646b'}"></fa-icon>

            <ul *dropdownMenu class="dropdown-menu" role="menu">
              <li role="menuitem"><a class="dropdown-item" [href]="downloadSingleFile(file.id)">Download</a></li>
              <li role="menuitem"><a class="dropdown-item"
                                     (click)="renameInit(file); renameInput.hidden = false; renameTextInput.setFocus();">Rename</a>
              </li>
              <li role="menuitem"><a class="dropdown-item" (click)="moveCopyInit(file)">Move / Copy</a></li>
              <li role="menuitem"><a class="dropdown-item"
                                     (click)="openModal(deleteTemplate); fileExplorerService.filesToDelete = [file]">Delete</a>
              </li>
            </ul>
          </div>
        </td>
        <td>{{convertToReadableFileSize(file.size)}}</td>
        <td>
          <div class="trim" popover="{{file.modificationDate | date :'medium'}}"
               triggers="mouseenter:mouseleave">{{file.modificationDate | timeago}}</div>
        </td>
      </tr>
      </tbody>
    </table>
    <div class="d-flex justify-content-center">
      <pagination [boundaryLinks]="true"
                  [totalItems]="totalItems"
                  [itemsPerPage]="itemsPerPage"
                  [(ngModel)]="currentPage"
                  (pageChanged)="pageChanged($event)"
                  previousText="&lsaquo;"
                  nextText="&rsaquo;"
                  firstText="&laquo;"
                  lastText="&raquo;">
      </pagination>
    </div>
  </div>
</div>


<ng-template #deleteTemplate>
  <div class="modal-body text-center">
    <p>Delete is permanent and cannot be reversed.
      <br/>Do you want to continue?</p>
    <button type="button" class="btn btn-dark mr-2" (click)="confirm()">Yes</button>
    <button type="button" class="btn btn-secondary" (click)="decline()">No</button>
  </div>
</ng-template>


<ng-template #shareTemplate>
  <div class="modal-header text-center">
    <p>Please insert the userName/login of the user you want to share this file/files with.</p>
  </div>
  <div class="modal-body">
    <form>
      <div class="form-group">
        <label for="recipient-name" class="col-form-label">Share with:</label>
        <input type="text" class="form-control" id="recipient-name">
      </div>
    </form>
  </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-dark mr-2" (click)="confirm()">Yes</button>
      <button type="button" class="btn btn-secondary" (click)="decline()">No</button>
    </div>

</ng-template>

